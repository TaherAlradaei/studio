rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- General Public Read Access ---
    // Anyone can read (view) files in the public directory.
    // This is essential for the welcome page, gallery, news, etc.
    match /public/{allPaths=**} {
      allow read: if true;
    }

    // --- Specific Write Rules ---
    // Rules are not inherited, so we must be specific.
    // Order matters: more specific paths should come first if they overlap.

    // Allow academy members OR an admin to upload to their posts folder.
    match /public/posts/{memberId}/{allPaths=**} {
      allow write: if request.auth != null && (request.auth.uid == memberId || request.auth.token.isAdmin == true);
    }

    // Allow ONLY admins to write to all other public folders.
    // This covers /logo, /gallery, /news, /backgrounds, etc.
    // We deny writes to /public/posts here unless the more specific rule above is met.
    match /public/{folder}/{allPaths=**} {
        // Deny non-admins from writing to any other folder that is NOT the posts folder they own.
        // Admins can write anywhere.
        allow write: if request.auth != null && request.auth.token.isAdmin == true;
    }
  }
}
